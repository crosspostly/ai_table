/**
 * Comprehensive Test Runner v1.0
 * –ó–∞–ø—É—Å–∫ –í–°–ï–• —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã
 */

/**
 * –ì–õ–ê–í–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è - –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
 */
function runAllComprehensiveTests() {
  Logger.log('üöÄ Starting COMPREHENSIVE test suite...');
  
  const startTime = Date.now();
  const allResults = {
    totalTests: 0,
    passed: 0,
    failed: 0,
    suites: []
  };
  
  // 1. SYNTAX & STRUCTURE TESTS
  Logger.log('\nüìã === PHASE 1: SYNTAX & STRUCTURE ===');
  const syntaxResults = runSyntaxTests();
  allResults.suites.push({ name: 'Syntax Tests', ...syntaxResults });
  allResults.totalTests += syntaxResults.totalTests;
  allResults.passed += syntaxResults.passed;
  allResults.failed += syntaxResults.failed;
  
  // 2. VALIDATION TESTS
  Logger.log('\nüõ°Ô∏è === PHASE 2: INPUT VALIDATION ===');
  const validationResults = runValidationTests();
  allResults.suites.push({ name: 'Validation Tests', ...validationResults });
  allResults.totalTests += validationResults.totalTests;
  allResults.passed += validationResults.passed;
  allResults.failed += validationResults.failed;
  
  // 3. RETRY LOGIC TESTS
  Logger.log('\nüîÑ === PHASE 3: RETRY LOGIC ===');
  const retryResults = runRetryLogicTests();
  allResults.suites.push({ name: 'Retry Logic Tests', ...retryResults });
  allResults.totalTests += retryResults.totalTests;
  allResults.passed += retryResults.passed;
  allResults.failed += retryResults.failed;
  
  // 4. ERROR HANDLING TESTS
  Logger.log('\nüí¨ === PHASE 4: ERROR HANDLING ===');
  const errorResults = runErrorHandlingTests();
  allResults.suites.push({ name: 'Error Handling Tests', ...errorResults });
  allResults.totalTests += errorResults.totalTests;
  allResults.passed += errorResults.passed;
  allResults.failed += errorResults.failed;
  
  // 5. PLATFORM DETECTION TESTS
  Logger.log('\nüîç === PHASE 5: PLATFORM DETECTION ===');
  const platformResults = runPlatformDetectionTests();
  allResults.suites.push({ name: 'Platform Detection Tests', ...platformResults });
  allResults.totalTests += platformResults.totalTests;
  allResults.passed += platformResults.passed;
  allResults.failed += platformResults.failed;
  
  // 6. REAL DATA TESTS (—Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ!)
  Logger.log('\nüß™ === PHASE 6: REAL DATA TESTS ===');
  const realDataResults = runRealDataTests();
  allResults.suites.push({ name: 'Real Data Tests', ...realDataResults });
  allResults.totalTests += realDataResults.totalTests || realDataResults.passed + realDataResults.failed;
  allResults.passed += realDataResults.passed;
  allResults.failed += realDataResults.failed;
  
  // 7. GEMINI SEQUENTIAL TESTS
  Logger.log('\nü§ñ === PHASE 7: GEMINI SEQUENTIAL TESTS ===');
  const geminiResults = runGeminiSequentialTests();
  allResults.suites.push({ name: 'Gemini Sequential Tests', ...geminiResults });
  allResults.totalTests += geminiResults.totalTests;
  allResults.passed += geminiResults.passed;
  allResults.failed += geminiResults.failed;
  
  // FINAL REPORT
  const duration = Date.now() - startTime;
  Logger.log('\nüìä ===============================');
  Logger.log('   üéØ COMPREHENSIVE TEST RESULTS');
  Logger.log('===============================');
  Logger.log(`‚è±Ô∏è Duration: ${Math.round(duration / 1000)}s`);
  Logger.log(`üìä Total Tests: ${allResults.totalTests}`);
  Logger.log(`‚úÖ Passed: ${allResults.passed}`);\n  Logger.log(`‚ùå Failed: ${allResults.failed}`);\n  Logger.log(`üìà Success Rate: ${Math.round((allResults.passed / allResults.totalTests) * 100)}%`);\n  \n  // –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∫–∞–∂–¥–æ–º—É –Ω–∞–±–æ—Ä—É\n  Logger.log('\\nüìã Detailed Results:');\n  allResults.suites.forEach(suite => {\n    const rate = suite.totalTests ? Math.round((suite.passed / suite.totalTests) * 100) : 0;\n    Logger.log(`  ${suite.passed}/${suite.totalTests || (suite.passed + suite.failed)} ${suite.name} (${rate}%)`);\n  });\n  \n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ª–∏—Å—Ç\n  writeTestResultsToSheet(allResults);\n  \n  return allResults;\n}\n\n/**\n * –¢–µ—Å—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n */\nfunction runSyntaxTests() {\n  Logger.log('‚ö° Running syntax tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  // –¢–µ—Å—Ç 1: –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç\n  results.totalTests++;\n  try {\n    const functionsToCheck = [\n      'importSocialPosts',\n      'parseSource', \n      'normalizePlatformName',\n      'importInstagramPosts',\n      'importTelegramPosts', \n      'importVkPostsAdvanced',\n      'validateAndSanitizeInputs',\n      'fetchWithRetry',\n      'createUserFriendlyError'\n    ];\n    \n    const missingFunctions = [];\n    functionsToCheck.forEach(funcName => {\n      if (typeof eval(funcName) !== 'function') {\n        missingFunctions.push(funcName);\n      }\n    });\n    \n    if (missingFunctions.length === 0) {\n      results.passed++;\n      results.details.push('‚úÖ All core functions exist');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå Missing functions: ${missingFunctions.join(', ')}`);\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Function check error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 2: –ü–∞—Ä—Å–∏–Ω–≥ URL —Ä–∞–±–æ—Ç–∞–µ—Ç\n  results.totalTests++;\n  try {\n    const testSource = parseSource('https://www.instagram.com/nasa/', null);\n    if (testSource.platform === 'instagram' && testSource.value === 'nasa') {\n      results.passed++;\n      results.details.push('‚úÖ URL parsing works');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå URL parsing failed: got ${JSON.stringify(testSource)}`);\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå URL parsing error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 3: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º\n  results.totalTests++;\n  try {\n    const testCases = [\n      ['–∏–Ω—Å—Ç–∞', 'instagram'],\n      ['—Ç–≥', 'telegram'], \n      ['–≤–∫', 'vk'],\n      ['instagram', 'instagram']\n    ];\n    \n    let allPassed = true;\n    for (const [input, expected] of testCases) {\n      const result = normalizePlatformName(input);\n      if (result !== expected) {\n        allPassed = false;\n        break;\n      }\n    }\n    \n    if (allPassed) {\n      results.passed++;\n      results.details.push('‚úÖ Platform normalization works');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå Platform normalization failed');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Platform normalization error: ${error.message}`);\n  }\n  \n  Logger.log(`Syntax Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n */\nfunction runValidationTests() {\n  Logger.log('üõ°Ô∏è Running validation tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  // –¢–µ—Å—Ç 1: –í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç\n  results.totalTests++;\n  try {\n    const valid = validateAndSanitizeInputs('https://instagram.com/nasa', 5, 'instagram');\n    if (valid.isValid && valid.sourceUrl && valid.count === 5) {\n      results.passed++;\n      results.details.push('‚úÖ Valid inputs pass validation');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå Valid inputs failed validation');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Valid input test error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 2: XSS –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è\n  results.totalTests++;\n  try {\n    validateAndSanitizeInputs('javascript:alert(\"xss\")', 5, '');\n    results.failed++;\n    results.details.push('‚ùå XSS not blocked');\n  } catch (error) {\n    if (error.message.includes('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª')) {\n      results.passed++;\n      results.details.push('‚úÖ XSS properly blocked');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå XSS test unexpected error: ${error.message}`);\n    }\n  }\n  \n  // –¢–µ—Å—Ç 3: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ count –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è\n  results.totalTests++;\n  try {\n    const result = validateAndSanitizeInputs('test', 'invalid', '');\n    if (result.count === 20) { // default value\n      results.passed++;\n      results.details.push('‚úÖ Invalid count fixed to default');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå Invalid count not fixed: got ${result.count}`);\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Count validation error: ${error.message}`);\n  }\n  \n  Logger.log(`Validation Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏\n */\nfunction runRetryLogicTests() {\n  Logger.log('üîÑ Running retry logic tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  // –¢–µ—Å—Ç 1: calculateBackoffDelay —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ\n  results.totalTests++;\n  try {\n    const delay1 = calculateBackoffDelay(1, 1000, 30000);\n    const delay2 = calculateBackoffDelay(2, 1000, 30000); \n    const delay3 = calculateBackoffDelay(10, 1000, 5000); // –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 5000\n    \n    if (delay1 >= 750 && delay1 <= 1250 && // 1000 ¬± jitter\n        delay2 >= 1500 && delay2 <= 2500 && // 2000 ¬± jitter\n        delay3 <= 5000) { // max delay limit\n      results.passed++;\n      results.details.push('‚úÖ Backoff delay calculation works');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå Backoff delays wrong: ${delay1}, ${delay2}, ${delay3}`);\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Backoff calculation error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 2: fetchWithRetry function exists and has right signature\n  results.totalTests++;\n  try {\n    if (typeof fetchWithRetry === 'function') {\n      results.passed++;\n      results.details.push('‚úÖ fetchWithRetry function exists');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå fetchWithRetry function missing');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå fetchWithRetry check error: ${error.message}`);\n  }\n  \n  Logger.log(`Retry Logic Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫\n */\nfunction runErrorHandlingTests() {\n  Logger.log('üí¨ Running error handling tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  // –¢–µ—Å—Ç 1: createUserFriendlyError —Ä–∞–±–æ—Ç–∞–µ—Ç\n  results.totalTests++;\n  try {\n    const techError = new Error('HTTP 403: Forbidden');\n    const friendlyError = createUserFriendlyError(techError, {\n      platform: 'instagram',\n      username: 'test'\n    });\n    \n    if (friendlyError.message.includes('üö´') && friendlyError.originalError === techError) {\n      results.passed++;\n      results.details.push('‚úÖ User-friendly errors work');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå User-friendly error generation failed');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Error handling test error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 2: HTTP code extraction —Ä–∞–±–æ—Ç–∞–µ—Ç\n  results.totalTests++;\n  try {\n    const httpCode = extractHttpCode('Request failed: HTTP 429 Too Many Requests');\n    if (httpCode === 429) {\n      results.passed++;\n      results.details.push('‚úÖ HTTP code extraction works');\n    } else {\n      results.failed++;\n      results.details.push(`‚ùå HTTP code extraction failed: got ${httpCode}`);\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå HTTP code extraction error: ${error.message}`);\n  }\n  \n  Logger.log(`Error Handling Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º\n */\nfunction runPlatformDetectionTests() {\n  Logger.log('üîç Running platform detection tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  const testCases = [\n    ['https://www.instagram.com/nasa/', null, 'instagram', 'nasa'],\n    ['https://t.me/durov', null, 'telegram', 'durov'],\n    ['https://vk.com/durov', null, 'vk', 'durov'],\n    ['durov', 'telegram', 'telegram', 'durov'],\n    ['@channel', 'telegram', 'telegram', 'channel']\n  ];\n  \n  testCases.forEach(([source, platform, expectedPlatform, expectedValue]) => {\n    results.totalTests++;\n    try {\n      const result = parseSource(source, normalizePlatformName(platform));\n      if (result.platform === expectedPlatform && result.value === expectedValue) {\n        results.passed++;\n        results.details.push(`‚úÖ ${source} ‚Üí ${expectedPlatform}`);\n      } else {\n        results.failed++;\n        results.details.push(`‚ùå ${source} ‚Üí expected ${expectedPlatform}:${expectedValue}, got ${result.platform}:${result.value}`);\n      }\n    } catch (error) {\n      if (platform === null && error.message.includes('—É–∫–∞–∂–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É')) {\n        results.passed++;\n        results.details.push(`‚úÖ ${source} ‚Üí correctly requires platform`);\n      } else {\n        results.failed++;\n        results.details.push(`‚ùå ${source} ‚Üí error: ${error.message}`);\n      }\n    }\n  });\n  \n  Logger.log(`Platform Detection Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö Gemini –∑–∞–ø—Ä–æ—Å–æ–≤\n */\nfunction runGeminiSequentialTests() {\n  Logger.log('ü§ñ Running Gemini sequential tests...');\n  \n  const results = { totalTests: 0, passed: 0, failed: 0, details: [] };\n  \n  // –¢–µ—Å—Ç 1: fetchGeminiWithRetry function exists\n  results.totalTests++;\n  try {\n    if (typeof fetchGeminiWithRetry === 'function') {\n      results.passed++;\n      results.details.push('‚úÖ fetchGeminiWithRetry function exists');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå fetchGeminiWithRetry function missing');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå Gemini function check error: ${error.message}`);\n  }\n  \n  // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ GM —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞\n  results.totalTests++;\n  try {\n    // –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ API\n    if (typeof GM === 'function') {\n      results.passed++;\n      results.details.push('‚úÖ GM function exists and updated');\n    } else {\n      results.failed++;\n      results.details.push('‚ùå GM function missing');\n    }\n  } catch (error) {\n    results.failed++;\n    results.details.push(`‚ùå GM function check error: ${error.message}`);\n  }\n  \n  Logger.log(`Gemini Sequential Tests: ${results.passed}/${results.totalTests} passed`);\n  return results;\n}\n\n/**\n * –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ –≤ Google Sheet\n */\nfunction writeTestResultsToSheet(results) {\n  try {\n    const ss = SpreadsheetApp.getActive();\n    let sheet = ss.getSheetByName('Test Results');\n    \n    if (!sheet) {\n      sheet = ss.insertSheet('Test Results');\n    }\n    \n    // –û—á–∏—â–∞–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏\n    sheet.clear();\n    const headers = ['Test Suite', 'Total', 'Passed', 'Failed', 'Success Rate', 'Details'];\n    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);\n    sheet.getRange(1, 1, 1, headers.length)\n      .setBackground('#4285f4')\n      .setFontColor('white')\n      .setFontWeight('bold');\n    \n    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n    const data = [];\n    results.suites.forEach(suite => {\n      const total = suite.totalTests || (suite.passed + suite.failed);\n      const rate = total ? Math.round((suite.passed / total) * 100) : 0;\n      data.push([\n        suite.name,\n        total,\n        suite.passed, \n        suite.failed,\n        rate + '%',\n        (suite.details || []).join('; ')\n      ]);\n    });\n    \n    // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞\n    const totalRate = results.totalTests ? Math.round((results.passed / results.totalTests) * 100) : 0;\n    data.push([\n      'TOTAL',\n      results.totalTests,\n      results.passed,\n      results.failed, \n      totalRate + '%',\n      'Comprehensive test run completed'\n    ]);\n    \n    if (data.length > 0) {\n      sheet.getRange(2, 1, data.length, headers.length).setValues(data);\n      \n      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É\n      const totalRow = data.length + 1;\n      sheet.getRange(totalRow, 1, 1, headers.length)\n        .setBackground('#f0f0f0')\n        .setFontWeight('bold');\n    }\n    \n    sheet.autoResizeColumns(1, headers.length);\n    Logger.log('‚úÖ Test results written to \"Test Results\" sheet');\n    \n  } catch (error) {\n    Logger.log('‚ùå Failed to write test results to sheet: ' + error.message);\n  }\n}"