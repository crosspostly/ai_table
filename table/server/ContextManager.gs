/**
 * Context Manager v2.0
 * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å Gemini –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—â–µ–Ω–∏—è
 * 
 * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
 * - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
 * - –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±—ä–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
 * - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
 */

/**
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
 */
var CONTEXT_SETTINGS = {
  MAX_HISTORY_ITEMS: 100,         // –ú–∞–∫—Å–∏–º—É–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (—É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 10 —Ä–∞–∑)
  MAX_CONTEXT_LENGTH: 150000,     // –ú–∞–∫—Å–∏–º—É–º —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (—É–≤–µ–ª–∏—á–µ–Ω–æ –≤ 10 —Ä–∞–∑)
  CONTEXT_TTL_HOURS: 24,          // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Å–∞—Ö
  AUTO_CLEANUP_ENABLED: true,     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
  CONTEXT_ENABLED_CELL: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã!C1' // –Ø—á–µ–π–∫–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –≤–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
};\n\n/**\n * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç\n * @return {boolean}\n */\nfunction isContextEnabled() {\n  try {\n    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();\n    var sheet = spreadsheet.getSheetByName('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã');\n    \n    if (!sheet) {\n      addSystemLog('‚ö†Ô∏è –õ–∏—Å—Ç \"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã\" –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∫–ª—é—á–µ–Ω', 'WARN', 'CONTEXT');\n      return false;\n    }\n    \n    var cellValue = sheet.getRange('C1').getValue();\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã \"–≤–∫–ª—é—á–µ–Ω–æ\"\n    if (typeof cellValue === 'boolean') {\n      return cellValue;\n    }\n    \n    if (typeof cellValue === 'string') {\n      var lowerValue = cellValue.toLowerCase().trim();\n      return lowerValue === 'true' || lowerValue === '–¥–∞' || lowerValue === '–≤–∫–ª—é—á–µ–Ω' || lowerValue === '1' || lowerValue === '‚úì';\n    }\n    \n    return false;\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n    return false;\n  }\n}\n\n/**\n * –ü–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'default')\n * @return {string}\n */\nfunction getContextCacheKey(sessionId) {\n  sessionId = sessionId || 'default';\n  return 'context_history_' + sessionId;\n}\n\n/**\n * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏\n * @return {Array<Object>} –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {role: 'user'|'assistant', content: string, timestamp: number}\n */\nfunction getContextHistory(sessionId) {\n  try {\n    if (!isContextEnabled()) {\n      return [];\n    }\n    \n    var cache = CacheService.getScriptCache();\n    var cacheKey = getContextCacheKey(sessionId);\n    var historyJson = cache.get(cacheKey);\n    \n    if (!historyJson) {\n      return [];\n    }\n    \n    var history = JSON.parse(historyJson);\n    \n    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏\n    var cutoffTime = Date.now() - (CONTEXT_SETTINGS.CONTEXT_TTL_HOURS * 60 * 60 * 1000);\n    history = history.filter(function(item) {\n      return item.timestamp > cutoffTime;\n    });\n    \n    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n    if (history.length > CONTEXT_SETTINGS.MAX_HISTORY_ITEMS) {\n      history = history.slice(-CONTEXT_SETTINGS.MAX_HISTORY_ITEMS);\n    }\n    \n    addSystemLog('üìñ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + history.length + ' —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 'INFO', 'CONTEXT');\n    return history;\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n    return [];\n  }\n}\n\n/**\n * –î–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n * @param {string} role - —Ä–æ–ª—å ('user' –∏–ª–∏ 'assistant')\n * @param {string} content - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏\n */\nfunction addToContextHistory(role, content, sessionId) {\n  try {\n    if (!isContextEnabled()) {\n      return;\n    }\n    \n    if (!role || !content) {\n      return;\n    }\n    \n    var history = getContextHistory(sessionId);\n    \n    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç\n    var newItem = {\n      role: role,\n      content: String(content),\n      timestamp: Date.now()\n    };\n    \n    history.push(newItem);\n    \n    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä\n    history = limitContextSize(history);\n    \n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à\n    var cache = CacheService.getScriptCache();\n    var cacheKey = getContextCacheKey(sessionId);\n    var ttl = CONTEXT_SETTINGS.CONTEXT_TTL_HOURS * 60 * 60; // –í —Å–µ–∫—É–Ω–¥–∞—Ö\n    \n    cache.put(cacheKey, JSON.stringify(history), ttl);\n    \n    addSystemLog('üí¨ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ' + role + ' (' + content.length + ' —Å–∏–º–≤.)', 'INFO', 'CONTEXT');\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ' + error.message, 'ERROR', 'CONTEXT');\n  }\n}\n\n/**\n * –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n * @param {Array<Object>} history - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\n * @return {Array<Object>} - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è\n */\nfunction limitContextSize(history) {\n  if (!history || !Array.isArray(history)) {\n    return [];\n  }\n  \n  // –°–Ω–∞—á–∞–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É\n  if (history.length > CONTEXT_SETTINGS.MAX_HISTORY_ITEMS) {\n    history = history.slice(-CONTEXT_SETTINGS.MAX_HISTORY_ITEMS);\n  }\n  \n  // –ü–æ—Ç–æ–º –ø–æ –æ–±—â–µ–º—É —Ä–∞–∑–º–µ—Ä—É\n  var totalLength = 0;\n  var limitedHistory = [];\n  \n  // –ò–¥–µ–º —Å –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n  for (var i = history.length - 1; i >= 0; i--) {\n    var item = history[i];\n    var itemLength = item.content ? item.content.length : 0;\n    \n    if (totalLength + itemLength <= CONTEXT_SETTINGS.MAX_CONTEXT_LENGTH) {\n      limitedHistory.unshift(item);\n      totalLength += itemLength;\n    } else {\n      break;\n    }\n  }\n  \n  return limitedHistory;\n}\n\n/**\n * –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Gemini\n * @param {string} currentPrompt - —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏\n * @return {string} - –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º\n */\nfunction buildContextualPrompt(currentPrompt, sessionId) {\n  try {\n    if (!isContextEnabled()) {\n      return currentPrompt;\n    }\n    \n    var history = getContextHistory(sessionId);\n    \n    if (history.length === 0) {\n      return currentPrompt;\n    }\n    \n    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n    var contextLines = ['=== –ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –û–ë–©–ï–ù–ò–Ø ==='];\n    \n    for (var i = 0; i < history.length; i++) {\n      var item = history[i];\n      var roleLabel = item.role === 'user' ? '–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨' : '–ê–°–°–ò–°–¢–ï–ù–¢';\n      contextLines.push(roleLabel + ': ' + item.content);\n    }\n    \n    contextLines.push('=== –¢–ï–ö–£–©–ò–ô –ó–ê–ü–†–û–° ===');\n    contextLines.push(currentPrompt);\n    \n    var fullPrompt = contextLines.join('\\n\\n');\n    \n    addSystemLog('üß† –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç: ' + history.length + ' —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏, ' + fullPrompt.length + ' —Å–∏–º–≤–æ–ª–æ–≤', 'INFO', 'CONTEXT');\n    \n    return fullPrompt;\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n    return currentPrompt;\n  }\n}\n\n/**\n * –û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –æ—á–∏—â–∞—é—Ç—Å—è –≤—Å–µ)\n */\nfunction clearContextHistory(sessionId) {\n  try {\n    var cache = CacheService.getScriptCache();\n    \n    if (sessionId) {\n      // –û—á–∏—â–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é\n      var cacheKey = getContextCacheKey(sessionId);\n      cache.remove(cacheKey);\n      addSystemLog('üßπ –û—á–∏—â–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏: ' + sessionId, 'INFO', 'CONTEXT');\n    } else {\n      // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã (—ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â—É—é –æ—á–∏—Å—Ç–∫—É)\n      // –í Google Apps Script –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏,\n      // –ø–æ—ç—Ç–æ–º—É –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ\n      var commonSessionIds = ['default', 'chat', 'chain'];\n      var cleared = 0;\n      \n      for (var i = 0; i < commonSessionIds.length; i++) {\n        var key = getContextCacheKey(commonSessionIds[i]);\n        if (cache.get(key)) {\n          cache.remove(key);\n          cleared++;\n        }\n      }\n      \n      addSystemLog('üßπ –û—á–∏—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: ' + cleared, 'INFO', 'CONTEXT');\n    }\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n  }\n}\n\n/**\n * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤\n */\nfunction autoCleanupContexts() {\n  try {\n    if (!CONTEXT_SETTINGS.AUTO_CLEANUP_ENABLED) {\n      return;\n    }\n    \n    addSystemLog('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤', 'INFO', 'CONTEXT');\n    \n    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã\n    // (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏)\n    var commonSessionIds = ['default', 'chat', 'chain'];\n    \n    for (var i = 0; i < commonSessionIds.length; i++) {\n      var sessionId = commonSessionIds[i];\n      var history = getContextHistory(sessionId);\n      \n      if (history.length > 0) {\n        // –ü–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é\n        var cache = CacheService.getScriptCache();\n        var cacheKey = getContextCacheKey(sessionId);\n        var ttl = CONTEXT_SETTINGS.CONTEXT_TTL_HOURS * 60 * 60;\n        \n        cache.put(cacheKey, JSON.stringify(history), ttl);\n      }\n    }\n    \n    addSystemLog('‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'INFO', 'CONTEXT');\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: ' + error.message, 'ERROR', 'CONTEXT');\n  }\n}\n\n/**\n * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º\n * @return {Object} - –æ–±—ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π\n */\nfunction getContextStatistics() {\n  try {\n    var stats = {\n      enabled: isContextEnabled(),\n      sessions: {},\n      totalItems: 0,\n      totalSize: 0\n    };\n    \n    if (!stats.enabled) {\n      return stats;\n    }\n    \n    var commonSessionIds = ['default', 'chat', 'chain'];\n    \n    for (var i = 0; i < commonSessionIds.length; i++) {\n      var sessionId = commonSessionIds[i];\n      var history = getContextHistory(sessionId);\n      \n      if (history.length > 0) {\n        var sessionSize = 0;\n        for (var j = 0; j < history.length; j++) {\n          sessionSize += history[j].content ? history[j].content.length : 0;\n        }\n        \n        stats.sessions[sessionId] = {\n          items: history.length,\n          size: sessionSize\n        };\n        \n        stats.totalItems += history.length;\n        stats.totalSize += sessionSize;\n      }\n    }\n    \n    return stats;\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n    return {\n      enabled: false,\n      sessions: {},\n      totalItems: 0,\n      totalSize: 0,\n      error: error.message\n    };\n  }\n}\n\n/**\n * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n * @param {string} sessionId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏\n * @return {string} - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è\n */\nfunction exportContextHistory(sessionId) {\n  try {\n    var history = getContextHistory(sessionId || 'default');\n    \n    if (history.length === 0) {\n      return '–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—É—Å—Ç–∞.';\n    }\n    \n    var lines = ['=== –ò–°–¢–û–†–ò–Ø –ö–û–ù–¢–ï–ö–°–¢–ê ===', ''];\n    \n    for (var i = 0; i < history.length; i++) {\n      var item = history[i];\n      var date = new Date(item.timestamp);\n      var timeStr = Utilities.formatDate(date, Session.getScriptTimeZone(), 'dd.MM.yyyy HH:mm:ss');\n      var roleLabel = item.role === 'user' ? '–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨' : '–ê–°–°–ò–°–¢–ï–ù–¢';\n      \n      lines.push('[' + timeStr + '] ' + roleLabel + ':');\n      lines.push(item.content);\n      lines.push('');\n    }\n    \n    return lines.join('\\n');\n    \n  } catch (error) {\n    addSystemLog('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ' + error.message, 'ERROR', 'CONTEXT');\n    return '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message;\n  }\n}"