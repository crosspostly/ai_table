<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
        padding: 20px;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        padding: 40px;
        max-width: 500px;
        width: 100%;
      }
      
      .icon {
        text-align: center;
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      h1 {
        color: #333;
        text-align: center;
        margin: 0 0 10px 0;
        font-size: 28px;
      }
      
      .subtitle {
        color: #666;
        text-align: center;
        margin: 0 0 30px 0;
        font-size: 14px;
      }
      
      .status-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
      }
      
      .status-item {
        display: flex;
        align-items: center;
        margin: 12px 0;
        font-size: 14px;
      }
      
      .status-icon {
        margin-right: 12px;
        font-size: 20px;
      }
      
      .status-text {
        flex: 1;
      }
      
      .error-list {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      
      .error-item {
        margin: 8px 0;
        font-size: 13px;
        color: #856404;
      }
      
      .instructions {
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      
      .instructions-title {
        font-weight: bold;
        color: #1976d2;
        margin-bottom: 10px;
      }
      
      .instructions ol {
        margin: 10px 0;
        padding-left: 20px;
      }
      
      .instructions li {
        margin: 8px 0;
        color: #0d47a1;
        font-size: 13px;
      }
      
      .button-container {
        display: flex;
        gap: 12px;
        margin-top: 30px;
      }
      
      button {
        flex: 1;
        padding: 14px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }
      
      .btn-secondary {
        background: #f1f3f4;
        color: #5f6368;
      }
      
      .btn-secondary:hover {
        background: #e8eaed;
      }
      
      .btn-test {
        background: #34a853;
        color: white;
      }
      
      .btn-test:hover {
        background: #2d8f46;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(52, 168, 83, 0.4);
      }
      
      .loading {
        text-align: center;
        padding: 20px;
      }
      
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .success-message {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="icon">üîê</div>
      <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</h1>
      <p class="subtitle">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π</p>
      
      <div id="content">
        <div class="loading">
          <div class="spinner"></div>
          <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</p>
        </div>
      </div>
      
      <div class="button-container" id="buttons" style="display: none;">
        <button class="btn-primary" onclick="authorize()">üöÄ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å</button>
        <button class="btn-test" onclick="testAuth()">üß™ –¢–µ—Å—Ç</button>
        <button class="btn-secondary" onclick="google.script.host.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    
    <script>
      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      window.onload = function() {
        checkStatus();
      };
      
      function checkStatus() {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</p>
          </div>
        `;
        
        google.script.run
          .withSuccessHandler(displayStatus)
          .withFailureHandler(displayError)
          .checkAuthorizationStatus();
      }
      
      function displayStatus(status) {
        let html = '';
        
        if (status.authorized) {
          html = `
            <div class="success-message">
              <strong>‚úÖ –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ!</strong><br>
              –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.
            </div>
            
            <div class="status-card">
              <div class="status-item">
                <span class="status-icon">üë§</span>
                <span class="status-text">Email: <strong>${status.userEmail || '–¥–æ—Å—Ç—É–ø–µ–Ω'}</strong></span>
              </div>
              <div class="status-item">
                <span class="status-icon">üìä</span>
                <span class="status-text">–¢–∞–±–ª–∏—Ü—ã: <strong>${status.spreadsheetAccess ? '‚úÖ' : '‚ùå'}</strong></span>
              </div>
              <div class="status-item">
                <span class="status-icon">üåê</span>
                <span class="status-text">–í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã: <strong>${status.urlFetchAccess ? '‚úÖ' : '‚ùå'}</strong></span>
              </div>
            </div>
          `;
        } else {
          html = `
            <div class="error-list">
              <strong>‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong>
              ${status.errors.map(err => `<div class="error-item">‚Ä¢ ${err}</div>`).join('')}
            </div>
            
            ${status.missingScopes.length > 0 ? `
              <div class="status-card">
                <strong>üîë –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:</strong>
                ${status.missingScopes.map(scope => {
                  const name = scope.split('/').pop();
                  return `<div class="status-item">
                    <span class="status-icon">‚ö†Ô∏è</span>
                    <span class="status-text">${name}</span>
                  </div>`;
                }).join('')}
              </div>
            ` : ''}
            
            <div class="instructions">
              <div class="instructions-title">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</div>
              <ol>
                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üöÄ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å" –Ω–∏–∂–µ</li>
                <li>–í –Ω–æ–≤–æ–º –æ–∫–Ω–µ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"</li>
                <li>–í—ã–±–µ—Ä–∏—Ç–µ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)"</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</li>
              </ol>
              <small>üí° –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ - —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏</small>
            </div>
          `;
        }
        
        document.getElementById('content').innerHTML = html;
        document.getElementById('buttons').style.display = 'flex';
      }
      
      function displayError(error) {
        document.getElementById('content').innerHTML = `
          <div class="error-list">
            <strong>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</strong>
            <div class="error-item">${error.message}</div>
          </div>
        `;
        document.getElementById('buttons').style.display = 'flex';
      }
      
      function authorize() {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</p>
          </div>
        `;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result) {
              document.getElementById('content').innerHTML = `
                <div class="success-message">
                  <strong>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</strong><br>
                  –í—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã. –ú–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ.
                </div>
              `;
            } else {
              checkStatus();
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('content').innerHTML = `
              <div class="error-list">
                <strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ</strong>
                <div class="error-item">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ.</div>
                <div class="error-item">–ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–µ–Ω—é.</div>
              </div>
            `;
          })
          .initiateAuthorizationFlow();
      }
      
      function testAuth() {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...</p>
          </div>
        `;
        
        google.script.run
          .withSuccessHandler(function(passed) {
            if (passed) {
              document.getElementById('content').innerHTML = `
                <div class="success-message">
                  <strong>üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!</strong><br>
                  –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.
                </div>
              `;
            } else {
              checkStatus();
            }
          })
          .withFailureHandler(displayError)
          .testAuthorization();
      }
    </script>
  </body>
</html>
