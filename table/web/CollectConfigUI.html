<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f8f9fa;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
    
    h2 {
      margin: 0 0 8px 0;
      color: #202124;
      font-size: 22px;
      font-weight: 400;
    }
    
    .cell-info {
      background: #e8f0fe;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 24px;
      color: #1967d2;
      font-weight: 500;
    }
    
    .section {
      margin-bottom: 24px;
    }
    
    .section-title {
      font-weight: 500;
      margin-bottom: 12px;
      color: #5f6368;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .cell-preview {
      margin-top: 4px;
      padding: 8px;
      background: #f8f9fa;
      border-left: 3px solid #1a73e8;
      border-radius: 4px;
      font-size: 12px;
      color: #5f6368;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 60px;
      overflow-y: auto;
    }
    
    .cell-preview.empty {
      color: #9aa0a6;
      font-style: italic;
    }
    
    .cell-preview.error {
      border-left-color: #ea4335;
      color: #d93025;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 13px;
      color: #5f6368;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      cursor: pointer;
      user-select: none;
    }
    
    select, input[type="text"] {
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #1a73e8;
    }
    
    select {
      flex: 1;
    }
    
    input[type="text"] {
      flex: 0 0 120px;
    }
    
    .data-item {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    
    .data-item select {
      flex: 1;
    }
    
    .data-item input {
      flex: 0 0 120px;
    }
    
    .remove-btn {
      background: #fff;
      border: 1px solid #dadce0;
      color: #5f6368;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .remove-btn:hover {
      background: #f8f9fa;
      border-color: #d93025;
      color: #d93025;
    }
    
    .add-btn {
      background: #fff;
      border: 1px solid #1a73e8;
      color: #1a73e8;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      width: 100%;
    }
    
    .add-btn:hover {
      background: #e8f0fe;
    }
    
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn-primary {
      grid-column: 1 / -1;
      background: #1a73e8;
      color: white;
    }
    
    .btn-reset {
      grid-column: 1 / -1;
    }
    
    .btn-primary:hover {
      background: #1765cc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    
    .btn-secondary {
      background: #fff;
      color: #5f6368;
      border: 1px solid #dadce0;
    }
    
    .btn-secondary:hover {
      background: #f8f9fa;
    }
    
    .btn-danger {
      background: #fff;
      color: #d93025;
      border: 1px solid #dadce0;
    }
    
    .btn-danger:hover {
      background: #fce8e6;
      border-color: #d93025;
    }
    
    .status {
      padding: 12px;
      border-radius: 4px;
      margin-top: 16px;
      display: none;
    }
    
    .status.success {
      background: #e6f4ea;
      color: #137333;
    }
    
    .status.error {
      background: #fce8e6;
      color: #c5221f;
    }
    
    .loading {
      text-align: center;
      color: #5f6368;
      padding: 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #dadce0;
      border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI –∑–∞–ø—Ä–æ—Å–∞</h2>
    <div class="cell-info" id="cellInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <!-- System Prompt -->
    <div class="section">
      <div class="section-title">üìç System Prompt (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI)</div>
      <div class="input-group">
        <select id="systemSheet" onchange="updateSystemPreview()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç...</option>
        </select>
        <input type="text" id="systemCell" placeholder="A1 –∏–ª–∏ C" onblur="updateSystemPreview()" />
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="systemWholeColumn" onchange="handleColumnCheckbox('system')" />
        <label for="systemWholeColumn">üìä –í—ã–±—Ä–∞—Ç—å –≤–µ—Å—å —Å—Ç–æ–ª–±–µ—Ü (C ‚Üí C1:C)</label>
      </div>
      <div id="systemPreview" class="cell-preview" style="display:none;"></div>
    </div>
    
    <!-- User Data -->
    <div class="section">
      <div class="section-title">üì¶ User Data (–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏)</div>
      <div id="userDataList"></div>
      <button class="add-btn" onclick="addUserDataRow()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <!-- Preset (Template) Save Section -->
    <div class="section">
      <div class="section-title">üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
      <div class="input-group">
        <input type="text" id="presetName" placeholder="–ò–º—è —à–∞–±–ª–æ–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)" style="flex: 1;" />
        <input type="text" id="presetDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="flex: 1;" />
      </div>
      <div style="font-size: 12px; color: #5f6368; margin-top: 4px;">
        üí° –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∏–º—è ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω
      </div>
    </div>
    
    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="runConfig()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="saveOnly()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="saveAsPreset()">üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      <button class="btn btn-danger btn-reset" onclick="resetConfig()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    
    <div class="status" id="status"></div>
  </div>

  <script>
    let sheetName = '';
    let cellAddress = '';
    let sheets = [];
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    google.script.run
      .withSuccessHandler(initialize)
      .withFailureHandler(showError)
      .getCollectConfigInitData();
    
    function initialize(data) {
      sheetName = data.sheetName;
      cellAddress = data.cellAddress;
      sheets = data.sheets;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —è—á–µ–π–∫–µ
      document.getElementById('cellInfo').textContent = 
        'üìå –Ø—á–µ–π–∫–∞: ' + sheetName + ' ‚Üí ' + cellAddress;
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ª–∏—Å—Ç–æ–≤
      const systemSheet = document.getElementById('systemSheet');
      sheets.forEach(function(sheet) {
        const option = document.createElement('option');
        option.value = sheet;
        option.textContent = sheet;
        systemSheet.appendChild(option);
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      loadExistingConfig();
    }
    
    function loadExistingConfig() {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º System Prompt
            if (config.systemPrompt) {
              document.getElementById('systemSheet').value = config.systemPrompt.sheet;
              document.getElementById('systemCell').value = config.systemPrompt.cell;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º User Data
            if (config.userData && config.userData.length > 0) {
              config.userData.forEach(function(data) {
                addUserDataRow(data.sheet, data.cell);
              });
            } else {
              addUserDataRow(); // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            }
          } else {
            addUserDataRow(); // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
          }
        })
        .withFailureHandler(function() {
          addUserDataRow(); // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        })
        .loadCollectConfig(sheetName, cellAddress);
    }
    
    function addUserDataRow(sheet, cell) {
      const container = document.getElementById('userDataList');
      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '12px';
      
      const item = document.createElement('div');
      item.className = 'data-item';
      
      const select = document.createElement('select');
      sheets.forEach(function(s) {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        if (s === sheet) option.selected = true;
        select.appendChild(option);
      });
      
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'A1 –∏–ª–∏ C';
      input.value = cell || '';
      
      // –ß–µ–∫–±–æ–∫—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Å–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'checkbox-group';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'wholeColumn_' + Date.now();
      
      const checkboxLabel = document.createElement('label');
      checkboxLabel.setAttribute('for', checkbox.id);
      checkboxLabel.textContent = 'üìä –í–µ—Å—å —Å—Ç–æ–ª–±–µ—Ü';
      
      checkboxWrapper.appendChild(checkbox);
      checkboxWrapper.appendChild(checkboxLabel);
      
      const preview = document.createElement('div');
      preview.className = 'cell-preview';
      preview.style.display = 'none';
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      const updatePreview = function() {
        const s = select.value;
        const c = input.value.trim();
        
        if (s && c) {
          google.script.run
            .withSuccessHandler(function(text) {
              preview.textContent = text;
              preview.style.display = 'block';
              
              if (text.startsWith('(–ø—É—Å—Ç–æ)')) {
                preview.className = 'cell-preview empty';
              } else if (text.startsWith('‚ùå')) {
                preview.className = 'cell-preview error';
              } else {
                preview.className = 'cell-preview';
              }
            })
            .getCellPreview(s, c);
        } else {
          preview.style.display = 'none';
        }
      };
      
      select.onchange = updatePreview;
      input.onblur = updatePreview;
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úï';
      removeBtn.onclick = function() {
        container.removeChild(wrapper);
      };
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ –ø–æ–ª–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü
      checkbox.onchange = function() {
        if (checkbox.checked) {
          const currentValue = input.value.trim();
          if (currentValue) {
            const columnLetter = extractColumnLetter(currentValue);
            if (columnLetter) {
              input.value = columnLetter + '1:' + columnLetter;
              updatePreview();
            }
          }
        }
      };
      
      item.appendChild(select);
      item.appendChild(input);
      item.appendChild(removeBtn);
      
      wrapper.appendChild(item);
      wrapper.appendChild(checkboxWrapper);
      wrapper.appendChild(preview);
      container.appendChild(wrapper);
      
      // –ó–∞–≥—Ä—É–∑–∏–º –ø—Ä–µ–≤—å—é –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
      if (sheet && cell) {
        updatePreview();
      }
    }
    
    function extractColumnLetter(cellRef) {
      // –ò–∑–≤–ª–µ–∫–∞–µ—Ç –±—É–∫–≤—É —Å—Ç–æ–ª–±—Ü–∞ –∏–∑ C, C1, C40 –∏ —Ç.–¥.
      const match = cellRef.match(/^([A-Z]+)\d*$/i);
      return match ? match[1].toUpperCase() : null;
    }
    
    function handleColumnCheckbox(type) {
      const checkbox = document.getElementById(type + 'WholeColumn');
      const input = document.getElementById(type + 'Cell');
      
      if (checkbox.checked) {
        const currentValue = input.value.trim();
        if (currentValue) {
          const columnLetter = extractColumnLetter(currentValue);
          if (columnLetter) {
            input.value = columnLetter + '1:' + columnLetter;
            updateSystemPreview();
          }
        }
      }
    }
    
    function updateSystemPreview() {
      const sheet = document.getElementById('systemSheet').value;
      const cell = document.getElementById('systemCell').value.trim();
      const preview = document.getElementById('systemPreview');
      
      if (sheet && cell) {
        google.script.run
          .withSuccessHandler(function(text) {
            preview.textContent = text;
            preview.style.display = 'block';
            
            if (text.startsWith('(–ø—É—Å—Ç–æ)')) {
              preview.className = 'cell-preview empty';
            } else if (text.startsWith('‚ùå')) {
              preview.className = 'cell-preview error';
            } else {
              preview.className = 'cell-preview';
            }
          })
          .getCellPreview(sheet, cell);
      } else {
        preview.style.display = 'none';
      }
    }
    
    function collectConfig() {
      const systemSheet = document.getElementById('systemSheet').value;
      const systemCell = document.getElementById('systemCell').value;
      
      const config = {
        systemPrompt: systemSheet && systemCell ? {
          sheet: systemSheet,
          cell: systemCell
        } : null,
        userData: []
      };
      
      const dataItems = document.querySelectorAll('.data-item');
      dataItems.forEach(function(item) {
        const sheet = item.querySelector('select').value;
        const cell = item.querySelector('input').value;
        if (sheet && cell) {
          config.userData.push({ sheet: sheet, cell: cell });
        }
      });
      
      return config;
    }
    
    function saveOnly() {
      const config = collectConfig();
      showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');
      
      google.script.run
        .withSuccessHandler(function() {
          showStatus('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
        })
        .withFailureHandler(function(error) {
          showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error, 'error');
        })
        .saveCollectConfig(sheetName, cellAddress, config);
    }
    
    function saveAsPreset() {
      const presetName = document.getElementById('presetName').value.trim();
      if (!presetName) {
        showStatus('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è —à–∞–±–ª–æ–Ω–∞!', 'error');
        return;
      }
      const config = collectConfig();
      const descEl = document.getElementById('presetDesc');
      const presetDesc = descEl ? descEl.value.trim() : '';
      if (presetDesc) {
        config.description = presetDesc;
      }
      if (!config.systemPrompt && config.userData.length === 0) {
        showStatus('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ!', 'error');
        return;
      }
      showStatus('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ "' + presetName + '"...', 'info');
      
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            showStatus('‚úÖ –®–∞–±–ª–æ–Ω "' + presetName + '" —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
            setTimeout(function() {
              document.getElementById('presetName').value = '';
              if (descEl) descEl.value = '';
            }, 2000);
          } else {
            showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞: ' + (error && error.message ? error.message : error), 'error');
        })
        .saveConfigAsPreset(presetName, config);
    }
    
    function runConfig() {
      const config = collectConfig();
      const presetName = document.getElementById('presetName').value.trim();
      const descEl = document.getElementById('presetDesc');
      const presetDesc = descEl ? descEl.value.trim() : '';
      
      if (!config.systemPrompt && config.userData.length === 0) {
        showStatus('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ!', 'error');
        return;
      }
      
      console.log('–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:', config);
      
      // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —à–∞–±–ª–æ–Ω–∞, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ preset
      if (presetName) {
        if (presetDesc) {
          config.description = presetDesc;
        }
        showStatus('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ "' + presetName + '" –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'info');
        
        google.script.run
          .withSuccessHandler(function(success) {
            if (success) {
              console.log('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é');
              executeConfig(config);
            } else {
              showStatus('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω, –Ω–æ –≤—ã–ø–æ–ª–Ω—è—é –∑–∞–ø—Ä–æ—Å...', 'info');
              executeConfig(config);
            }
          })
          .withFailureHandler(function(error) {
            console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞:', error);
            showStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞, –Ω–æ –≤—ã–ø–æ–ª–Ω—è—é –∑–∞–ø—Ä–æ—Å...', 'info');
            executeConfig(config);
          })
          .saveConfigAsPreset(presetName, config);
      } else {
        showStatus('üöÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'info');
        executeConfig(config);
      }
    }
    
    function executeConfig(config) {
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–¥–∏–Ω –≤—ã–∑–æ–≤ –Ω–æ–≤–æ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:', result);
          
          if (result.success) {
            showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ ' + cellAddress, 'success');
            setTimeout(function() {
              google.script.host.close();
            }, 2000);
          } else {
            showStatus('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
          showStatus('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + error.message, 'error');
        })
        .saveAndExecuteCollectConfig(sheetName, cellAddress, config);
    }
    
    function resetConfig() {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é?')) {
        google.script.run
          .withSuccessHandler(function() {
            showStatus('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞!', 'success');
            setTimeout(function() {
              google.script.host.close();
            }, 1000);
          })
          .withFailureHandler(function(error) {
            showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error, 'error');
          })
          .deleteCollectConfig(sheetName, cellAddress);
      }
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
    }
    
    function showError(error) {
      showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error, 'error');
    }
  </script>
</body>
</html>
