# 🎯 CollectConfig System - Полная Документация

## 📋 Что это?

**CollectConfig** - это система для создания сложных AI-запросов без ограничений на длину промпта.

### Проблема:
- Обычная функция `=GM("очень длинный промпт...")` имеет лимит Google Sheets на длину формулы
- Нельзя динамически собирать данные из разных ячеек
- Сложно управлять большими промптами

### Решение:
- ✅ **Визуальный интерфейс** - настраиваем через UI
- ✅ **Без лимитов** - промпты хранятся отдельно от формул
- ✅ **Динамические данные** - собирает данные из любых ячеек
- ✅ **Переиспользование** - сохраненные конфигурации можно обновлять

---

## 🏗️ Архитектура Системы

```
┌─────────────────────────────────────────────────────────────┐
│                  Google Sheets (UI)                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  🎯 AI Конструктор → Настроить запрос                │  │
│  │  (открывает modal dialog)                            │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ google.script.run
                     ▼
┌─────────────────────────────────────────────────────────────┐
│        CLIENT SIDE (table/web/CollectConfigUI.gs)          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  openCollectConfigUI()                                │  │
│  │  getCollectConfigInitData()                           │  │
│  │  getAllSheetNames()                                   │  │
│  │  getCellPreview()                                     │  │
│  └──────────┬────────────────────────────────────────────┘  │
└─────────────┼───────────────────────────────────────────────┘
              │
              │ HTML файл: CollectConfigUI.html
              ▼
┌─────────────────────────────────────────────────────────────┐
│           HTML UI (table/web/CollectConfigUI.html)          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📍 System Prompt:   [Лист▼] [Ячейка] [☑ Столбец]   │  │
│  │  📦 User Data:       [Лист▼] [Ячейка] [☑ Столбец]   │  │
│  │                      + Добавить данные                │  │
│  │                                                       │  │
│  │  [🚀 Запустить]  [💾 Сохранить]  [🔄 Сбросить]      │  │
│  └──────────┬────────────────────────────────────────────┘  │
└─────────────┼───────────────────────────────────────────────┘
              │
              │ google.script.run.saveCollectConfig()
              │ google.script.run.executeCollectConfig()
              ▼
┌─────────────────────────────────────────────────────────────┐
│    SERVER SIDE (table/server/ConfigurationManager.gs)      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  saveCollectConfig(sheetName, cellAddress, config)   │  │
│  │    ├─ Saves to hidden sheet "ConfigData"             │  │
│  │    └─ Structure: {systemPrompt, userData[], ...}     │  │
│  │                                                       │  │
│  │  executeCollectConfig(sheetName, cellAddress)        │  │
│  │    ├─ Load config from ConfigData                    │  │
│  │    ├─ Collect System Prompt from sheet+cell          │  │
│  │    ├─ Collect User Data from multiple sheets+cells   │  │
│  │    ├─ Format as JSON                                 │  │
│  │    ├─ Send to Gemini API                             │  │
│  │    └─ Write result to target cell                    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток Данных (Data Flow)

### 1️⃣ **Открытие Интерфейса**

```
USER: Нажимает "🎯 AI Конструктор → Настроить запрос"
  ↓
CLIENT: openCollectConfigUI()
  ├─ Создает HTML dialog
  └─ Вызывает getCollectConfigInitData()
      ↓
SERVER: Возвращает {sheetName, cellAddress, sheets[]}
      ↓
HTML: Заполняет выпадающие списки листов
```

### 2️⃣ **Сохранение Конфигурации**

```javascript
// HTML → CLIENT
google.script.run
  .withSuccessHandler(onSuccess)
  .withFailureHandler(onError)
  .saveCollectConfig(sheetName, cellAddress, config);

// config = {
//   systemPrompt: {sheet: "Инструкции", cell: "A1"},
//   userData: [
//     {sheet: "Данные", cell: "C1:C100"},
//     {sheet: "Параметры", cell: "B5"}
//   ]
// }
```

**SERVER обработка:**
```javascript
saveCollectConfig(sheetName, cellAddress, config) {
  1. Открывает скрытый лист "ConfigData"
  2. Ищет существующую строку для sheetName+cellAddress
  3. Если найдена → обновляет
  4. Если нет → добавляет новую строку
  5. Сохраняет JSON userData в ячейку
  6. Логирует операцию → addSystemLog()
}
```

### 3️⃣ **Выполнение Запроса**

```javascript
// HTML → CLIENT → SERVER
google.script.run
  .executeCollectConfig(sheetName, cellAddress);
```

**SERVER обработка:**
```javascript
executeCollectConfig(sheetName, cellAddress) {
  1. ✅ Проверка GEMINI_API_KEY
     └─ Если нет → return {success: false, error: "..."}
  
  2. 📥 Загрузка конфигурации
     config = loadCollectConfig(sheetName, cellAddress)
     └─ Читает из скрытого листа "ConfigData"
  
  3. 📍 Сбор System Prompt
     systemPrompt = collectDataFromRange(
       config.systemPrompt.sheet,
       config.systemPrompt.cell
     )
     └─ Читает значения из ячеек, объединяет в строку
  
  4. 📦 Сбор User Data (из всех источников)
     userData = []
     for each dataSource in config.userData:
       data = collectDataFromRange(dataSource.sheet, dataSource.cell)
       userData.push({source: "...", content: data})
  
  5. 🤖 Формирование запроса
     requestData = {
       systemInstruction: systemPrompt,
       userData: userData // JSON array
     }
  
  6. 🚀 Отправка в Gemini
     result = sendToGeminiWithJSON(requestData)
     └─ Вызывает callGeminiAPI() с форматированным промптом
  
  7. ✍️ Запись результата
     targetSheet.getRange(cellAddress).setValue(result)
  
  8. ✅ Логирование
     addSystemLog() на каждом шаге
     └─ Логи попадают в CacheService + консоль
  
  9. 🔄 Обновление LastRun
     updateLastRun(sheetName, cellAddress)
}
```

---

## 📊 Структура Хранения Данных

### ConfigData (скрытый лист)

| Sheet | Cell | SystemPromptSheet | SystemPromptCell | UserDataJSON | CreatedAt | LastRun |
|-------|------|-------------------|------------------|--------------|-----------|---------|
| Лист1 | B5   | Инструкции        | A1               | `[{"sheet":"Данные","cell":"C1:C"}]` | 2024-10-14T... | 2024-10-14T... |
| Анализ | C10  | Промпты           | B3               | `[{"sheet":"Таблица","cell":"A1:D100"}]` | 2024-10-14T... | null |

**UserDataJSON format:**
```json
[
  {
    "sheet": "Данные",
    "cell": "C1:C"
  },
  {
    "sheet": "Параметры",
    "cell": "B5"
  }
]
```

---

## 🔍 Логирование

### Где хранятся логи?

1. **CacheService** (временное хранение, 6 часов):
   - Ключ: `log_COMPONENT_timestamp`
   - Значение: JSON объект `{timestamp, level, component, message}`
   
2. **Консоль браузера** (client-side):
   - JavaScript в HTML файле: `console.log()`
   - Видно при нажатии F12 → Console

3. **Google Sheets лист** (критические ошибки):
   - Лист: "System Logs"
   - Только ERROR и CRITICAL

### Как посмотреть логи?

#### Вариант 1: Меню (рекомендуется)
```
🤖 Table AI → 🧰 DEV → 🔍 Показать логи AI Конструктора
```

#### Вариант 2: Консоль браузера
```
1. Открыть Google Sheets
2. Нажать F12
3. Вкладка "Console"
4. Нажать "🚀 Запустить" в UI
5. Смотреть детальные логи в консоли
```

#### Вариант 3: Экспорт в лист
```
🤖 Table AI → 🧰 DEV → 💾 Экспортировать логи в лист
```

### Уровни логирования

| Level | Значение | Когда используется |
|-------|----------|-------------------|
| `DEBUG` | Детальная диагностика | Все промежуточные шаги |
| `INFO` | Информация | Успешные операции |
| `WARN` | Предупреждения | Нештатные ситуации |
| `ERROR` | Ошибки | Сбои операций |
| `CRITICAL` | Критические ошибки | Полный отказ системы |

### Пример логов при выполнении

```
[2024-10-14 15:30:01] INFO [COLLECT_EXEC] → executeCollectConfig START: Лист1!B5
[2024-10-14 15:30:01] DEBUG [COLLECT_EXEC]    Загрузка конфигурации...
[2024-10-14 15:30:02] DEBUG [COLLECT_EXEC] ✅ Конфигурация загружена: {"systemPrompt":...}
[2024-10-14 15:30:02] DEBUG [COLLECT_EXEC]    Сбор System Prompt из Инструкции!A1
[2024-10-14 15:30:02] DEBUG [COLLECT_EXEC]    System Prompt: Проанализируй следующие данные и...
[2024-10-14 15:30:03] DEBUG [COLLECT_EXEC]    Сбор User Data из 2 источников
[2024-10-14 15:30:03] DEBUG [COLLECT_EXEC]      [0] Данные!C1:C
[2024-10-14 15:30:04] DEBUG [COLLECT_EXEC]      ✅ Собрано 15420 символов
[2024-10-14 15:30:04] DEBUG [COLLECT_EXEC]      [1] Параметры!B5
[2024-10-14 15:30:04] DEBUG [COLLECT_EXEC]      ✅ Собрано 245 символов
[2024-10-14 15:30:05] INFO [COLLECT_EXEC]    Отправка в Gemini...
[2024-10-14 15:30:12] INFO [COLLECT_EXEC] ✅ Получен ответ от Gemini: На основе анализа данных можно...
[2024-10-14 15:30:12] INFO [COLLECT_EXEC] ✅ Результат записан в Лист1!B5
```

---

## ⚙️ Настройка и Требования

### Обязательные настройки

1. **Gemini API Key**:
   ```
   🤖 Table AI → ⚙️ Настройки → 🌟 НАСТРОИТЬ ВСЕ КЛЮЧИ
   ```
   
2. **Листы с данными**:
   - Создайте лист с инструкцией для AI (System Prompt)
   - Создайте листы с данными для анализа

### Ограничения

- ❌ Максимум 100 источников User Data (практический лимит)
- ❌ Каждая ячейка/диапазон должен существовать
- ❌ Нельзя использовать формулы в качестве адресов
- ✅ Можно использовать диапазоны: `A1:Z100`, `C:C` (весь столбец)

---

## 🐛 Отладка и Решение Проблем

### Проблема: "Не сохраняется конфигурация"

**Диагностика:**
```
1. Откройте консоль браузера (F12)
2. Нажмите 💾 Сохранить
3. Ищите ошибки в Console
```

**Возможные причины:**
- ❌ Ошибка в JavaScript → смотрите console.error
- ❌ Ошибка на сервере → смотрите логи (🔍 Показать логи AI Конструктора)
- ❌ Нет прав на запись → проверьте права доступа к таблице

**Решение:**
```javascript
// Проверьте что функция вызывается:
google.script.run
  .withSuccessHandler(function(result) {
    console.log('SUCCESS:', result);  // ← должно быть true
  })
  .withFailureHandler(function(error) {
    console.error('ERROR:', error);   // ← если ошибка, будет здесь
  })
  .saveCollectConfig(sheetName, cellAddress, config);
```

### Проблема: "Не выполняется запрос"

**Пошаговая проверка:**
```
1. ✅ Gemini API Key настроен?
   🤖 Table AI → 📊 Проверить статус системы

2. ✅ Конфигурация сохранена?
   Нажмите 💾 Сохранить перед 🚀 Запустить

3. ✅ Листы существуют?
   Проверьте что все листы указанные в конфигурации существуют

4. ✅ Ячейки существуют?
   Проверьте что ячейки содержат данные
```

**Детальная диагностика:**
```
1. 🧰 DEV → 🔍 Показать логи AI Конструктора
2. Ищите строки с ERROR
3. Смотрите stack trace для понимания где именно ошибка
```

### Проблема: "Пустые логи"

**Причина:** Логи еще не созданы или срок хранения истек (6 часов в CacheService)

**Решение:**
```
1. Нажмите 🚀 Запустить или 💾 Сохранить
2. Сразу после этого откройте логи
3. Или используйте консоль браузера (F12) - логи там всегда есть
```

---

## 📚 Примеры Использования

### Пример 1: Анализ отзывов

**Структура:**
- Лист "Инструкция" (A1): "Проанализируй отзывы и выдели основные проблемы"
- Лист "Отзывы" (C1:C100): Список отзывов клиентов
- Результат в "Анализ" (B5)

**Настройка:**
1. Выделите ячейку Анализ!B5
2. 🎯 AI Конструктор → Настроить запрос
3. System Prompt: Лист = "Инструкция", Ячейка = "A1"
4. User Data: Лист = "Отзывы", Ячейка = "C1:C100", ☑ Весь столбец
5. 🚀 Запустить

### Пример 2: Генерация контента с параметрами

**Структура:**
- Лист "Промпт" (B1): "Напиши статью на тему {topic} длиной {length} слов в стиле {style}"
- Лист "Параметры":
  - B1: "искусственный интеллект"
  - B2: "1000"
  - B3: "научно-популярный"
- Результат в "Статьи" (A1)

**Настройка:**
1. Выделите ячейку Статьи!A1
2. 🎯 AI Конструктор → Настроить запрос
3. System Prompt: Лист = "Промпт", Ячейка = "B1"
4. User Data:
   - Добавить: Лист = "Параметры", Ячейка = "B1"
   - Добавить: Лист = "Параметры", Ячейка = "B2"
   - Добавить: Лист = "Параметры", Ячейка = "B3"
5. 🚀 Запустить

---

## 🔒 Безопасность

1. **API Keys**: Хранятся в PropertiesService (зашифрованы Google)
2. **Конфигурации**: Хранятся в скрытом листе (доступны только владельцу)
3. **Логи**: Не содержат API keys и токены
4. **Данные**: Не покидают вашу Google таблицу (кроме отправки в Gemini)

---

## 🚀 Roadmap

- [ ] Шаблоны конфигураций (сохранять с именами)
- [ ] История выполнений
- [ ] Предпросмотр собранного промпта
- [ ] Экспорт/импорт конфигураций
- [ ] Bulk операции (обновить сразу много ячеек)

---

## 📞 Поддержка

Если что-то не работает:

1. 📊 Проверьте логи: 🧰 DEV → 🔍 Показать логи AI Конструктора
2. 🔧 Проверьте статус: 🤖 Table AI → 📊 Проверить статус системы
3. 🌐 Откройте консоль: F12 → Console (смотрите красные ошибки)
4. 💾 Экспортируйте логи: 🧰 DEV → 💾 Экспортировать логи в лист
